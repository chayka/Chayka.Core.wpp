"use strict";angular.module("chayka-utils",[]).factory("utils",["$window","$timeout",function($window,$timeout){{var Chayka=$window.Chayka||{};Chayka.Utils=Chayka.Utils||{declare:function(classname,parent,implementation){for(var parts=classname.split("."),root=$window,part="",i=0;i<parts.length&&(part=parts[i],i!==parts.length-1);i++)root[part]=root[part]||{},root=root[part];return angular.isUndefined(implementation)&&(implementation=parent,parent=null),root[part]=parent?parent.extend&&angular.isFunction(parent.extend)?parent.extend(implementation):angular.extend(parent,implementation):implementation,root[part]},ensure:function(classname,extend){for(var parts=classname.split("."),root=$window,part="",i=0;i<parts.length;i++)part=parts[i],root[part]=root[part]||{},root=root[part];return extend&&angular.isObject(extend)&&angular.extend(root,extend),root},getItem:function(obj,key,defaultValue){void 0===defaultValue&&(defaultValue=null);var parts=(key+"").split(".");if(obj&&(angular.isObject(obj)||angular.isArray(obj))){for(var root=obj,i=0;i<parts.length;i++){var part=parts[i];if(!angular.isObject(root)&&!angular.isArray(root)||void 0===root[part])return defaultValue;root=root[part]}return root}return defaultValue},template:function(tpl,params){return tpl.replace(/{([^}]+)}/g,function(all,param){return params[param].toString()||""})},patchScope:function(scope){scope&&angular.isFunction(scope.$apply)&&$timeout(function(){scope.$apply()},0)}}}return Chayka.Utils}]),angular.module("chayka-translate",["pascalprecht.translate"]).config(["$translateProvider",function($translateProvider){var locale=window.Chayka&&window.Chayka.Core&&window.Chayka.Core.locale||"en-US";$translateProvider.preferredLanguage(locale)}]),angular.module("chayka-spinners",["chayka-translate","chayka-utils"]).directive("spinner",[function(){return{restrict:"AE",scope:{spinner:"=",visible:"=?",message:"=?"},template:'<div class="chayka-spinner" data-ng-show="visible">{{message}}</div>',controller:function($scope){$scope.show=function(message){$scope.message=message||$scope.message||"Loading...",$scope.visible=!0},$scope.hide=function(){$scope.visible=!1},$scope.spinner=$scope}}}]).directive("multiSpinner",[function(){return{restrict:"AE",scope:{spinner:"=multiSpinner"},template:'<div class="chayka-multi_spinner" data-ng-show="total"><div data-ng-repeat="(id, message) in messages"><div data-spinner="spinners[id]" data-message="message" data-visible="true"></div></div></div>',controller:function($scope){var ctrl={};$scope.spinners={},$scope.messages={},$scope.total=0,ctrl.show=function(message,id){return id||(id="spinner_"+$scope.total),$scope.messages[id]||($scope.messages[id]=message,$scope.total++),id},ctrl.hide=function(id){$scope.messages[id]&&($scope.total--,delete $scope.messages[id],$scope.spinners[id]=null)},$scope.spinner=ctrl}}}]).directive("generalSpinner",["utils","generalSpinner",function(utils){return{restrict:"AE",template:'<div class="chayka-general_spinner"><div data-multi-spinner="spinner"></div></div>',controller:function($scope){$scope.spinner=null;var $=angular.element;$(document).on("Chayka.Spinners.show",function(e,message,id){$scope.spinner&&($scope.spinner.show(message,id),utils.patchScope($scope))}),$(document).on("Chayka.Spinners.hide",function(e,id){$scope.spinner&&($scope.spinner.hide(id),utils.patchScope($scope))})}}}]).factory("generalSpinner",["utils",function(utils){var $=angular.element;return utils.ensure("Chayka.Spinners",{show:function(message,id){$(document).trigger("Chayka.Spinners.show",[message,id])},hide:function(id){$(document).trigger("Chayka.Spinners.hide",[id])}})}]),angular.module("chayka-ajax",["chayka-modals","chayka-spinners"]).factory("ajax",["$window","$http","$timeout","modals","generalSpinner","utils",function($window,$http,$timeout,modals,generalSpinner,utils){var Chayka=(angular.element,$window.Chayka||{}),ajax=Chayka.Ajax=Chayka.Ajax||{errorHandlers:{},addErrorHandler:function(id,handler,errorCode){errorCode=errorCode||null,ajax.errorHandlers[id]={code:errorCode,handler:handler}},removeErrorHandler:function(id){ajax.errorHandlers[id]=null},handleError:function(code,message,payload){var res=!1;for(var id in ajax.errorHandlers){var reg=ajax.errorHandlers[id];if(reg&&(!reg.code||reg.code===code)&&(res=res||reg.handler(code,message,payload)))break}return res},handleErrors:function(data){if(!data)return{empty_response:"Empty response"};if("mass_errors"===data.code){for(var code in data.message)ajax.handleError(code,data.message[code],data.payload)&&delete data.message[code];return data.message}var errors={};return ajax.handleError(data.code,data.message,data.payload)||(errors[data.code]=data.message),errors},processResponse:function(response,defaultMessage){var message=defaultMessage||!1,code=1;if(!angular.isUndefined(response.payload))return response;if(!response||angular.isString(response)&&!response.length)message="Empty response";else if(angular.isString(response)){var m=response.match(/<body[^>]*>([\s\S]*)<\/body>/m);m=m?m:response.match(/<br\s*\/>\s*<b>[^<]+<\/b>\:\s*(.*)<br\s*\/>/m),message=m?m[1].trim():defaultMessage}return{code:code,message:message,payload:null}},spinnersUsed:0,prepare:function(options){var defaults={};options=options||{},options=angular.extend(defaults,options);var spinner=options.spinner||null,spinnerId=options.spinnerId||"spinner",spinnerFieldId=options.spinnerFieldId,spinnerMessage=options.spinnerMessage||"Processing...",errorMessage=options.errorMessage||"Operation failed",successMessage=options.successMessage,formValidator=options.formValidator,validateOnSend=angular.isUndefined(options.validateOnSend)?!0:options.validateOnSend,scope=options.scope,send=options.send,success=options.success,error=options.error,complete=options.complete;spinnerId+=ajax.spinnersUsed++;var prepared={},sendHandler=function(){var result=!1;return!spinnerFieldId&&formValidator&&validateOnSend&&!formValidator.validateFields()?!1:(send&&angular.isFunction(send)&&(result=send()),result&&(spinner!==!1&&(spinner?spinner.show(spinnerMessage):spinnerFieldId&&formValidator?formValidator.setFieldState(spinnerFieldId,"progress",spinnerMessage):generalSpinner.show(spinnerMessage,spinnerId)),formValidator&&formValidator.clearMessage(),scope&&utils.patchScope(scope)),result)};prepared.send=sendHandler;var completeHandler=function(data,status,headers,config){spinner!==!1&&(spinner?spinner.hide():spinnerFieldId&&formValidator?formValidator.setFieldState(spinnerFieldId,"clean",spinnerMessage):generalSpinner.hide(spinnerId)),complete&&angular.isFunction(complete)&&complete(data,status,headers,config)};prepared.complete=completeHandler;var errorHandler=function(data,status,headers,config){data=ajax.processResponse(data,errorMessage),completeHandler(data,status,headers,config);var errors=ajax.handleErrors(data),message=errorMessage;for(var i in errors){message=errors[i]||errorMessage;break}formValidator?formValidator.showErrors(errors):message!==!1&&modals.alert(message),angular.isFunction(error)&&error(data,status,headers,config),scope&&utils.patchScope(scope)};prepared.error=errorHandler;var successHandler=function(data,status,headers,config){if(data=ajax.processResponse(data,errorMessage),data.code)errorHandler(data,status,headers,config);else{completeHandler(data,status,headers,config);var message=successMessage===!1?!1:data.message||successMessage;formValidator&&message&&formValidator.showMessage(message),success&&angular.isFunction(success)&&success(data,status,headers,config)}scope&&utils.patchScope(scope)};return prepared.success=successHandler,prepared},request:function(url,options){var data=options.data||null,method=options.method||"post",config=options.config||{},send=null;switch(method){case"get":send=function(){return $http.get(url,config)};break;case"delete":send=function(){return $http["delete"](url,config)};break;case"head":send=function(){return $http.head(url,config)};break;case"jsonp":send=function(){return $http.jsonp(url,config)};break;case"post":send=function(){return $http.post(url,data,config)};break;case"put":send=function(){return $http.put(url,data,config)};break;case"patch":send=function(){return $http.patch(url,data,config)}}options.send=send;var prepared=ajax.prepare(options),promise=prepared.send();return promise.success(prepared.success).error(prepared.error),promise},get:function(url,options,config){return options.method="get",options.config=config,ajax.request(url,options)},del:function(url,options,config){return options.method="delete",options.config=config,ajax.request(url,options)},head:function(url,options,config){return options.method="head",options.config=config,ajax.request(url,options)},jsonp:function(url,options,config){return options.method="jsonp",options.config=config,ajax.request(url,options)},post:function(url,data,options,config){return options.method="post",options.data=data,options.config=config,ajax.request(url,options)},put:function(url,data,options,config){return options.method="putt",options.data=data,options.config=config,ajax.request(url,options)},patch:function(url,data,options,config){return options.method="patch",options.data=data,options.config=config,ajax.request(url,options)}};return ajax}]),angular.module("chayka-modals",["chayka-translate","chayka-utils"]).controller("modalCtrl",["$scope","modals",function($scope,modals){modals.setQueueScope($scope),$scope.close=modals.close,$scope.queue=modals.queue}]).factory("modals",["$window","$translate","utils",function($window,$translate,utils){var modals=utils.ensure("Chayka.Modals",{queue:[],scope:null}),modal={isOpen:!1,show:function(){this.isOpen||(this.isOpen=!0,modals.queue.push(this),modals.scope&&utils.patchScope(modals.scope))},hide:function(){this.element&&this.element.appendTo(document.getElementById("chayka-modals-pool"));var m=modals.queue.shift();m.isOpen=!1}},api={setQueueScope:function($scope){modals.scope=$scope},create:function(options){if(options.buttons&&angular.isObject(options.buttons)&&!angular.isArray(options.buttons)){var buttons=[];angular.forEach(options.buttons,function(button,text){button.text=text,buttons.push(button)}),options.buttons=buttons}var defaultOptions={},m=angular.extend(defaultOptions,options,modal);return m.element&&m.element.data("modal",m),m},show:function(options){var m=api.create(options);return m.show(),m},alert:function(message,title,modalClass,callback){modalClass=modalClass||"modal_alert",api.show({content:message,title:title||"",modalClass:modalClass,buttons:[{text:$translate.instant("Ok"),click:callback}]})},confirm:function(message,callback,title){api.show({content:message,title:title||"",modalClass:"modal_confirm",buttons:[{text:$translate.instant("Yes"),click:callback},{text:$translate.instant("No")}]})},close:function(){var m=modals.queue.shift();m.isOpen=!1}};return modals=angular.extend(modals,api)}]).directive("modal",["modals",function(){return{restrict:"AE",transclude:!0,scope:{modal:"=modal",title:"=?modalTitle",show:"@modalShow"},template:document.getElementById("chayka-modals-template").innerHTML,link:function(scope){var ctrl={};ctrl.show=function(){scope.isOpen=!0},ctrl.hide=scope.hide=function(){scope.isOpen=!1},ctrl.setTitle=function(title){scope.title=title},ctrl.setButtons=function(buttons){if(buttons&&angular.isObject(buttons)&&!angular.isArray(buttons)){var btns=[];angular.forEach(buttons,function(button,text){button.text=text,btns.push(button)}),buttons=btns}scope.buttons=buttons},scope.modal=ctrl,scope.show&&ctrl.show()},controller:function(){}}}]).config(["$translateProvider",function($translateProvider){$translateProvider.translations("en-US",{Yes:"Yes",No:"No",Ok:"Ok"}),$translateProvider.translations("ru-RU",{Yes:"Да",No:"Нет",Ok:"Ok"})}]),angular.module("chayka-forms",["ngSanitize","chayka-modals","chayka-translate","chayka-ajax"]).directive("formValidator",["$window","modals","ajax","utils",function($window,modals,ajax,utils){return{restrict:"AE",scope:{validator:"=formValidator",scrollMargin:"@",scrollDuration:"@"},link:function(scope,element){scope.element=element},controller:function($scope){var fields=$scope.fields={},ctrl=this,messageBox=null;$scope.scrollMargin=$scope.scrollMargin||50,ctrl.setMessageBox=function(msgBox){messageBox=msgBox},ctrl.showMessage=function(message,state){return messageBox?(messageBox.message=message,messageBox.state=state||"",!0):(modals.alert(message,"",state),!1)},ctrl.clearMessage=function(){return messageBox?(messageBox.message="",messageBox.state="",!0):!1},ctrl.addField=function(field){fields[field.name]=field},ctrl.setFieldState=function(field,state,message){(!angular.isString(field)||(field=fields[field]))&&(field.valid="valid"===state||"clean"===state,field.state=state,field.message=message||field.hint,utils.patchScope(field))},ctrl.setFieldError=function(field,message){ctrl.setFieldState(field,"invalid",message)},ctrl.clearFieldError=function(field){ctrl.setFieldState(field,"clear")},ctrl.checkRequired=function(field){return!!field.value},ctrl.checkLength=function(field){var c=field.checks.length;return!(c.max&&field.value.length>c.max||field.value.length<c.min)},ctrl.checkRange=function(field){var c=field.checks.range,lower=c.min&&(c.minE&&field.value<c.min||!c.minE&&field.value<=c.min),greater=c.max&&(c.maxE&&field.value>c.max||!c.minE&&field.value>=c.max);return!(lower||greater)},ctrl.checkLt=function(field){var c=field.checks.lt;return field.value<c.max},ctrl.checkLe=function(field){var c=field.checks.le;return field.value<=c.max},ctrl.checkGt=function(field){var c=field.checks.gt;return field.value>c.min},ctrl.checkGe=function(field){var c=field.checks.ge;return field.value>=c.min},ctrl.checkRegexp=function(field){var c=field.checks.regexp,valid=c.regexp.test(field.value);return c.forbid&&(valid=!valid),valid},ctrl.checkPasswords=function(field){var c=field.checks.passwords,repeatField=fields[c.repeat]||field;return field.value===repeatField.value},ctrl.checkApi=function(field){var c=field.checks.api,url=utils.template(c.url,{name:encodeURIComponent(field.name),value:encodeURIComponent(field.value)}),value=field.value+"";return value in c.dictionary?("valid"===c.dictionary[value]?ctrl.setFieldState(field,"valid",null):ctrl.setFieldState(field,"invalid",c.message),c.dictionary[value]):(c.dictionary[value]="progress",ajax.get(url,{spinner:$scope.spinner,spinnerFieldId:field.name,spinnerMessage:" ",showMessage:!1,formValidator:ctrl,errorMessage:c.message,scope:field,success:function(){c.dictionary[value]="valid",ctrl.setFieldState(field,"valid",null)},error:function(data){c.dictionary[value]="invalid",c.message=c.message||"mass_errors"===data.code&&data.message[field.name]||data.message}}),c.dictionary[value])},ctrl.checkCustom=function(field){var c=field.checks.custom,callback=c.callback;return $scope.$parent[callback].call($scope,field.value)},ctrl.validateField=function(field,silent){var state,valid=!0,message="",checks=field.checks;return field.active?(checks.required&&!ctrl.checkRequired(field)&&(valid=!1,message=checks.required.message),field.value&&angular.forEach(checks,function(c,check){if(valid){switch(check){case"length":valid=ctrl.checkLength(field);break;case"range":valid=ctrl.checkRange(field);break;case"lt":valid=ctrl.checkLt(field);break;case"le":valid=ctrl.checkLe(field);break;case"gt":valid=ctrl.checkGt(field);break;case"ge":valid=ctrl.checkGe(field);break;case"regexp":valid=ctrl.checkRegexp(field);break;case"passwords":valid=ctrl.checkPasswords(field)}valid||(message=c.message)}}),valid&&checks.custom&&(valid=ctrl.checkCustom(field),message=valid?"":checks.custom.message),state=valid?"valid":"invalid",valid&&checks.api&&(state=ctrl.checkApi(field),message="invalid"===state?checks.api.message:""),silent||ctrl.setFieldState(field,state,message),field.valid):!0},ctrl.validateFields=function(){var valid=!0,scrollTo=0;return angular.forEach(fields,function(field){if(!ctrl.validateField(field)){var scrollPos=field.element.offset().top;(!scrollTo||scrollPos&&scrollTo>scrollPos)&&(scrollTo=scrollPos),valid=!1}}),!valid&&scrollTo&&ctrl.scrollTo(scrollTo),$scope.valid=valid,valid},ctrl.scrollTo=function(scrollTo,duration){if(angular.isUndefined(duration)&&(duration=parseInt($scope.scrollDuration)||$scope.scrollDuration),scrollTo-=parseInt($scope.scrollMargin),$window.jQuery){var $=$window.jQuery;(scrollTo<$window.pageYOffset||scrollTo>$window.pageYOffset+$($window).height())&&(duration?$window.jQuery("html, body").animate({scrollTop:scrollTo},duration):$window.jQuery("html, body").scrollTop(scrollTo))}},ctrl.scrollUp=function(duration){ctrl.scrollTo($scope.element.offset().top,duration)},ctrl.showErrors=function(errors){var scrollTo=0;angular.forEach(errors,function(message,key){var field=fields[key];if(field){ctrl.setFieldState(field,"invalid",message);var scrollPos=field.element.offset().top;(!scrollTo||scrollPos&&scrollTo>scrollPos)&&(scrollTo=scrollPos)}else ctrl.showMessage(message,"error")}),scrollTo&&ctrl.scrollTo(scrollTo)},$scope.validator=ctrl}}}]).directive("formField",["$translate","delayedCall","utils",function($translate,delayedCall,utils){return{require:"^formValidator",restrict:"AE",transclude:!0,template:'<label>{{label}}</label><div class="input" data-ng-transclude></div><div class="message" data-ng-class="{error: !valid}" data-ng-bind-html="message">{{message}}</div>',scope:{name:"@formField",label:"@",hint:"@",message:"@hint"},link:function(scope,element,attrs,formCtrl){function setupIf(){attrs.checkIf&&scope.$parent.$watch(attrs.checkIf,function(value){scope.active=value})}function setupRequired(){scope.checks.required={message:attrs.checkRequired||$translate.instant("message_required")}}function setupLength(){var short=attrs.checkLength,shorts=short?short.split("|"):[],min=parseInt(shorts[1]||attrs.checkLengthMin||0),max=parseInt(shorts[2]||attrs.checkLengthMax||0),messageTemplate=shorts[0]||attrs.checkLengthMessage||$translate.instant("message_length"),message=utils.template(messageTemplate,{min:min,max:max,label:scope.label});scope.checks.length={message:message,min:min,max:max}}function setupRange(){var short=attrs.checkRange,shorts=short?short.split("|"):[],minStr=shorts[1]||attrs.checkRangeMin||0,minE=!!minStr.match(/^=/),min=minE?minStr.substr(1):minStr,maxStr=shorts[2]||attrs.checkRangeMax||0,maxE=!!maxStr.match(/^=/),max=maxE?maxStr.substr(1):maxStr,format=shorts[3]||attrs.checkRangeFormat||"int";switch(format){case"int":min=parseInt(min),max=parseInt(max);break;case"float":min=parseFloat(min),max=parseFloat(max)}var messageTemplate=shorts[0]||attrs.checkRangeMessage||$translate.instant("message_range"),message=utils.template(messageTemplate,{min:min,max:max,label:scope.label});scope.checks.range={message:message,min:min,minE:minE,max:max,maxE:maxE}}function setupLt(){var short=attrs.checkLt,shorts=short?short.split("|"):[],max=shorts[1]||attrs.checkLtMax||0,messageTemplate=shorts[0]||attrs.checkLtMessage||$translate.instant("message_lt"),message=utils.template(messageTemplate,{max:max,label:scope.label}),format=shorts[2]||attrs.checkLtFormat||"int";switch(format){case"int":max=parseInt(max);break;case"float":max=parseFloat(max)}scope.checks.lt={message:message,max:max}}function setupLe(){var short=attrs.checkLe,shorts=short?short.split("|"):[],max=shorts[1]||attrs.checkLeMax||0,messageTemplate=shorts[0]||attrs.checkLeMessage||$translate.instant("message_le"),message=utils.template(messageTemplate,{max:max,label:scope.label}),format=shorts[2]||attrs.checkLeFormat||"int";switch(format){case"int":max=parseInt(max);break;case"float":max=parseFloat(max)}scope.checks.le={message:message,max:max}}function setupGt(){var short=attrs.checkGt,shorts=short?short.split("|"):[],min=shorts[1]||attrs.checkGtMin||0,messageTemplate=shorts[0]||attrs.checkGtMessage||$translate.instant("message_gt"),message=utils.template(messageTemplate,{min:min,label:scope.label}),format=shorts[2]||attrs.checkGtFormat||"int";switch(format){case"int":min=parseInt(min);break;case"float":min=parseFloat(min)}scope.checks.gt={message:message,min:min}}function setupGe(){var short=attrs.checkGe,shorts=short?short.split("|"):[],min=shorts[1]||attrs.checkGeMin||0,messageTemplate=shorts[0]||attrs.checkGeMessage||$translate.instant("message_ge"),message=utils.template(messageTemplate,{min:min,label:scope.label}),format=shorts[2]||attrs.checkGeFormat||"int";switch(format){case"int":min=parseInt(min);break;case"float":min=parseFloat(min)}scope.checks.ge={message:message,min:min}}function setupRegExp(){var short=attrs.checkRegexp,shorts=short?short.split("|"):[],patternAndModifiers=short&&/\/(.*)\/(\w*)$/.exec(shorts[1])||[],message=shorts[0]||attrs.checkRegexpMessage||$translate.instant("message_regexp"),pattern=patternAndModifiers[1]||attrs.checkRegexpPattern||".*",modifiers=patternAndModifiers[2]||attrs.checkRegexpModifiers||"",forbid=shorts[2]||attrs.checkRegexpForbid||!1,regexp=new RegExp(pattern,modifiers);scope.checks.regexp={message:message,regexp:regexp,forbid:forbid}}function setupEmail(){var message=attrs.checkEmail||$translate.instant("message_email");scope.checks.regexp={message:message,regexp:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,forbid:!1}}function setupPasswords(){var short=attrs.checkPasswords,shorts=short?short.split("|"):[],repeat=shorts[0]||attrs.checkPasswordsRepeat,message=shorts[1]||attrs.checkPasswordsMessage||$translate.instant("message_passwords");scope.checks.passwords={message:message,repeat:repeat}}function setupApiCall(){var short=attrs.checkApi,shorts=short?short.split("|"):[],url=shorts[0]||attrs.checkApiUrl,message=shorts[1]||attrs.checkApiMessage,delay=shorts[2]||attrs.checkApiDelay||0;scope.checks.api={message:message,url:url,delay:delay,dictionary:{}},input.on("keyup change",function(){formCtrl.setFieldState(scope,"clean"),utils.patchScope(scope),scope.value&&delayedCall("check-api-"+scope.name,delay,function(){formCtrl.validateField(scope,!0),utils.patchScope(scope)})})}function setupCustom(){var short=attrs.checkCustom,shorts=short?short.split("|"):[],callback=shorts[0]||attrs.checkCustomCallback,message=shorts[1]||attrs.checkCustomMessage||$translate.instant("message_custom");scope.checks.custom={message:message,callback:callback}}var input=element.find("[ng-model],[data-ng-model]"),inputType=input.attr("type"),model=input.attr("data-ng-model")||input.attr("ng-model"),label=element.find(".input > label:first-child"),$label=element.find("> label");scope.label||"checkbox"===inputType||"radio"===inputType||(scope.label=label.text().replace(/\s*:\s*$/,""),angular.forEach(label.attributes,function(i,attr){var name=attr.name,value=attr.value;$label.attr(name,value)}),$label.addClass(label.attr("class")),$label.text(scope.label),label.remove()),scope.valid=!0,scope.state="clean",scope.active=!0,scope.checks={},scope.element=element,input.focus(function(){}),input.blur(function(){scope.value&&formCtrl.validateField(scope,!1),utils.patchScope(scope)}),angular.forEach(attrs,function(attr,key){var m=key.match(/^check([A-Z][a-z]*)/),check=m&&m[1];if(check&&!scope.checks[check])switch(check){case"If":setupIf();break;case"Required":setupRequired();break;case"Length":setupLength();break;case"Le":setupLe();break;case"Lt":setupLt();break;case"Ge":setupGe();break;case"Gt":setupGt();break;case"Range":setupRange();break;case"Regexp":setupRegExp();break;case"Email":setupEmail();break;case"Passwords":setupPasswords();break;case"Api":setupApiCall();break;case"Custom":setupCustom()}}),scope.$parent.$watch(model,function(value){scope.value=value}),scope.$watch("state",function(value){element.removeClass("clean progress valid invalid"),element.addClass(value)}),formCtrl.addField(scope)},controller:function(){}}}]).directive("formMessage",function(){return{require:"^formValidator",restrict:"AE",replace:!0,template:'<div class="form-message {{state}}" data-ng-show="!!message" data-ng-bind-html="message"></div>',scope:{message:"@"},link:function(scope,element,attrs,formCtrl){scope.message="",scope.state="",formCtrl.setMessageBox(scope)}}}).factory("delayedCall",["$timeout",function($timeout){var timeouts={};return function(callId,delay,callback){var handle=timeouts[callId];handle&&$timeout.cancel(handle),timeouts[callId]=$timeout(function(){timeouts[callId]=null,callback()},delay)}}]).config(["$translateProvider",function($translateProvider){$translateProvider.translations("en-US",{message_required:"Required Field",message_length:"The length of this value should be between {min} and {max} symbols",message_range:"The value should be between {min} and {max}",message_lt:"The value should be lower than {max}",message_le:"The value should be lower than {max} or equal",message_gt:"The value should be greater than {min}",message_ge:"The value should be greater than {min} or equal",message_regexp:"Invalid format",message_email:"Valid email format: user@domain.com",message_passwords:"Passwords do not match",message_custom:"Invalid value"}),$translateProvider.translations("ru-RU",{message_required:"Обязательное поле",message_length:"Длина значения должна быть от {min} до {max} символов",message_range:"Значение должно быть в диапазоне от {min} до {max}",message_lt:"Значение должно быть меньше {max}",message_le:"Значение должно быть меньше или равно {max}",message_gt:"Значение должно быть больше {min}",message_ge:"Значение должно быть больше или равно {min}",message_regexp:"Некорректный формат",message_email:"Формат email: user@domain.com",message_passwords:"Введенные пароли отличаются",message_custom:"Некорректное значение"})}]),angular.module("chayka-options-form",["chayka-forms"]).controller("optionsForm",["$scope","$timeout","ajax",function($scope,$timeout,ajax){$scope.namespace="",$scope.options={site:{}},$scope.validator=null;var processResponse=function(data){angular.forEach(data.payload,function(value,option){$scope.options[option]=value})};$scope.saveOptions=function(){(!$scope.validator||$scope.validator.validateFields())&&ajax.post("/api/options/set",{namespace:$scope.namespace,options:$scope.options},{spinnerMessage:"Saving options",success:processResponse})},$scope.loadOptions=function(){ajax.post("/api/options/get",{namespace:$scope.namespace,options:$scope.options},{spinnerMessage:"Loading options",success:processResponse})},$timeout($scope.loadOptions,0)}]);