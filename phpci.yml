build_settings:
#    clone_depth: 1 # depth of 1 is a shallow clone, remove this line to clone entire repo

setup:
    composer:
        action: "install"
    shell:
        - "rm -rf ${WP_CI_DIR}wp-content/plugins/Chayka.Core.wpp"
        - "mkdir ${WP_CI_DIR}wp-content/plugins/Chayka.Core.wpp"
        - "cp -R ./* ${WP_CI_DIR}wp-content/plugins/Chayka.Core.wpp"
        - "chown -R www-data:www-data ${WP_CI_DIR}wp-content/plugins/Chayka.Core.wpp"
        - "cd ${WP_CI_DIR} && wp --allow-root plugin activate Chayka.Core.wpp"

test:
    shell:
        - "phpunit --tap"
        - 'cd ./tests/casperjs/ && ./test.sh | sed "s/\[\d+;\d+m//g"'

complete:

success:
    package_build:
        format: "zip"
        directory: "${CI_RELEASE_DIR}"
        filename: "Chayka.Core.wpp.%build.commit%"
    shell:
        - "curl ${CI_RELEASE_HOOK_URL} > /dev/null > /dev/null 2&>1"
